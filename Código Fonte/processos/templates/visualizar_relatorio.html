<!DOCTYPE html>
<html lang="pt-br">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>Visualizar Relatorio</title>
        <link rel="stylesheet"
              href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
    </head>
    <body>
        <div class="container">
            <h2 class="mt-4">Informações do Processo</h2>
            <div class="card mt-4">
                <div class="card-header">
                    <h5 class="card-title">{{ processo.razao_solicitacao }}</h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        {% for imagem in imagens %}
                            <div class="col-md-4">
                                <img src="{{ imagem.imagem.url }}"
                                     alt="Imagem do processo"
                                     class="img-fluid">
                            </div>
                        {% endfor %}
                    </div>
                    <p class="card-text mt-3">Descrição da Situação da Árvore: {{ processo.razao_solicitacao }}</p>
                    <p class="card-text">Endereço: {{ processo.endereco }}</p>
                    <p class="card-text">Fatores de Risco:</p>
                    <ul>
                        <li>fator 1</li>
                        <li>fator 2</li>
                        <li>fator 3</li>
                    </ul>
                    <p class="card-text">Documentos Anexados:</p>
                    <div class="row">
                        {% for documento in documentos %}
                            <div class="col-md-4">
                                <img src="{{ documento.imagem.url }}" alt="Documento" class="img-fluid">
                            </div>
                        {% endfor %}
                    </div>
                    <h5 class="card-text mt-5 mb-2">Atualize o andamento do processo:</h5>
                    <!-- atualizar o andamento gera um parecer tecnico-->
                    <form>
                        <div class="form-group">
                            <select id="status-select"
                                    class="form-select w-auto"
                                    aria-label="Default select example"
                                    name="status">
                                <option {% if "ABERTO" in processo.status %}selected{% endif %}
                                        value="ABERTO">Aberto</option>
                                <option {% if "EM_ANALISE" in processo.status %}selected{% endif %}
                                        value="EM_ANALISE">Em Análise</option>
                                <option {% if "CANCELADO" in processo.status %}selected{% endif %}
                                        value="CANCELADO">Cancelado</option>
                                <option {% if "ENCERRADO" in processo.status %}selected{% endif %}
                                        value="ENCERRADO">Encerrado</option>
                                <option {% if "ENCAMINHADO" in processo.status %}selected{% endif %}
                                        value="ENCAMINHADO">Encaminhado</option>
                            </select>
                        </div>
                        <div class="form-group mt-3">
                            <label for="laudo">Laudo:</label>
                            <textarea class="form-control"
                                      id="laudo"
                                      rows="3"
                                      style="resize: none;
                                             height: 150px"></textarea>
                        </div>
                        <div class="form-group mt-3">
                            <label for="justificativa">Justificativa:</label>
                            <textarea class="form-control"
                                      id="justificativa"
                                      rows="3"
                                      style="resize: none;
                                             height: 150px"></textarea>
                        </div>
                        <div class="form-group mt-3">
                            <label for="recomendacao">Recomendação:</label>
                            <textarea class="form-control"
                                      id="recomendacao"
                                      rows="3"
                                      style="resize: none;
                                             height: 150px"></textarea>
                        </div>
                    </form>
                    <a type="button" class="btn btn-success mt-2" id="atualizar-botao">Atualizar Processo</a>
                </div>
            </div>
        </div>
    </body>
    <script>
  const selectElement = document.getElementById('status-select');
  const updateButton = document.getElementById('atualizar-botao');
  const laudoTextarea = document.getElementById('laudo');
  const justificativaTextarea = document.getElementById('justificativa');
  const recomendacaoTextarea = document.getElementById('recomendacao');




  updateButton.addEventListener('click', () => {
    const novoStatus = selectElement.value;
    const laudo = laudoTextarea.value.trim();
    const justificativa = justificativaTextarea.value.trim();
    const recomendacao = recomendacaoTextarea.value.trim();

    if (!laudo || !justificativa || !recomendacao) {
      alert('Todos os campos devem ser preenchidos antes de atualizar o processo.');
      return;
    }

    fetch(`/atualizar-processo/{{processo.id}}/`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'X-CSRFToken': getCookie('csrftoken')
      },
      body: JSON.stringify({
        'status': novoStatus,
        'laudo': laudo,
        'justificativa': justificativa,
        'recomendacao': recomendacao,
      })
    })
      .then(response => {
        if (response.ok) {
          alert('Status atualizado com sucesso!');
        } else {
          console.error('Erro ao atualizar o status');
        }
      })
      .catch(error => {
        console.error('Erro:', error);
      });
  });

  function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
      const cookies = document.cookie.split(';');
      for (let i = 0; i < cookies.length; i++) {
        const cookie = cookies[i].trim();
        if (cookie.substring(0, name.length + 1) === (name + '=')) {
          cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
          break;
        }
      }
    }
    return cookieValue;
  }
    </script>
</html>
